<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voco CRM - Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© */
        body { font-family: 'Cairo', sans-serif !important; background-color: #f0f2f5; margin: 0; font-size: 13px; direction: rtl; text-align: right; padding-bottom: 80px; }
        h1, h2, h3, h4, h5, h6, th, .fw-bold { font-weight: 700; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª */
        @keyframes bubble { 0% { transform: translateY(0); opacity: 0.6; } 100% { transform: translateY(-700px); opacity: 0; } }
        .bubbles { position: absolute; bottom: -150px; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 1; }
        .bubbles li { position: absolute; display: block; list-style: none; width: 20px; height: 20px; background: rgba(255, 255, 255, 0.2); animation: bubble 25s linear infinite; border-radius: 50%; }
        .bubbles li:nth-child(1) { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .bubbles li:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar { width: 250px; height: 100vh; background-color: #1e3a8a; padding: 20px; position: fixed; top: 0; right: 0; z-index: 1000; box-shadow: -5px 0 15px rgba(0,0,0,0.2); transition: all 0.3s ease; }
        .sidebar a { display: flex; align-items: center; padding: 12px 15px; margin-bottom: 10px; color: #d1d5db; text-decoration: none; border-radius: 10px; transition: all 0.3s ease; }
        .sidebar a:hover, .sidebar a.active { background-color: #3b82f6; color: white; transform: translateX(-8px); }
        .sidebar i { margin-left: 10px; width: 20px; text-align: center; }
        .sidebar .logo-text { color: white; font-weight: 900; font-size: 22px; margin-right: 10px; }

        .main-content { margin-right: 250px; padding: 30px; transition: all 0.3s ease; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background-color: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 2000; justify-content: space-around; padding: 10px 0; border-top-left-radius: 15px; border-top-right-radius: 15px; }
        .bottom-nav a { color: #999; text-decoration: none; text-align: center; font-size: 12px; flex: 1; }
        .bottom-nav a i { display: block; font-size: 20px; margin-bottom: 5px; }
        .bottom-nav a.active { color: #1e3a8a; font-weight: bold; }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-right: 0; padding: 15px; }
            .bottom-nav { display: flex; }
            .status-card h2 { font-size: 35px; }
        }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .status-card { border: none; border-radius: 20px; color: white; padding: 25px; height: 150px; position: relative; overflow: hidden; transition: transform 0.3s ease; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .status-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .card-visits { background: linear-gradient(135deg, #FF5722, #e64a19); } 
        .card-reps { background: linear-gradient(135deg, #00C853, #00a647); } 
        .status-card h2, .status-card p { position: relative; z-index: 2; }

        /* Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .notification-btn { position: relative; border: none; background: white; width: 45px; height: 45px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #1e3a8a; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .notification-btn:hover { background-color: #e0f2fe; transform: translateY(-2px); }
        .badge-notify { position: absolute; top: -5px; right: -5px; background: #FF5722; color: white; border-radius: 50%; padding: 4px 6px; font-size: 10px; border: 2px solid white; font-weight: bold; display: none; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„ÙÙ„Ø§ØªØ± */
        .filter-section { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-right: 5px solid #1e3a8a; }
        .table-responsive { background: white; border-radius: 15px; padding: 20px; margin-top: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.05); }
        
        /* ğŸ› ï¸ ØªØ¹Ø¯ÙŠÙ„ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„ÙŠØªØ­Ù…Ù„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        .table thead th { background-color: #1e3a8a; color: white; padding: 12px 10px; border: none; font-size: 12px; white-space: nowrap; }
        .table tbody td { padding: 12px 10px; vertical-align: middle; white-space: nowrap; font-size: 12px; }
        .table tbody tr:hover { background-color: #f0f7ff; cursor: pointer; }
        
        /* Badges Ù„Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        .badge-place { background-color: #e0f2fe; color: #0284c7; padding: 3px 8px; border-radius: 6px; font-weight: bold; font-size: 11px; }
        .badge-interested { background-color: #dcfce7; color: #166534; padding: 3px 8px; border-radius: 6px; font-weight: bold; font-size: 11px; }
        .badge-not-interested { background-color: #fee2e2; color: #991b1b; padding: 3px 8px; border-radius: 6px; font-weight: bold; font-size: 11px; }

        /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù… */
        .dark-mode { background-color: #121212 !important; color: #e0e0e0 !important; }
        .dark-mode .sidebar { background-color: #1f1f1f !important; }
        .dark-mode .bottom-nav { background-color: #1f1f1f !important; border-top: 1px solid #333; }
        .dark-mode .bottom-nav a.active { color: #bb86fc; }
        .dark-mode .filter-section, .dark-mode .table-responsive { background-color: #1e1e1e !important; box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .dark-mode .table tbody tr:hover { background-color: #2c2c2c !important; }
        .dark-mode .table thead th { background-color: #3700b3 !important; }
        .dark-mode .table tbody td { color: #e0e0e0 !important; }
        .dark-mode input, .dark-mode select { background-color: #2c2c2c !important; color: #e0e0e0 !important; border-color: #3700b3 !important; }
        .dark-mode .notification-btn { background-color: #2c2c2c; color: #bb86fc; }
    </style>
</head>
<body>

    <div class="sidebar" data-aos="fade-right" data-aos-duration="1200">
        <div class="d-flex align-items-center mb-5 border-bottom pb-3">
            <i class="fas fa-satellite-dish fa-2x" style="color: #FF5722; margin-left: 10px;"></i>
            <h5 class="mb-0 logo-text">VOCO CRM</h5>
        </div>
        <a href="dashboard.html" class="active"><i class="fas fa-tachometer-alt"></i>Dashboard</a>
        <a href="reports.html"><i class="fas fa-chart-line"></i>Reports</a>
        <a href="users.html"><i class="fas fa-users"></i>Users</a>
        <a href="settings.html"><i class="fas fa-cog"></i>Settings</a>
        <a href="#" onclick="toggleDarkMode(event)" id="darkModeToggle" style="margin-top: 50px;">
            <i class="fas fa-moon"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù…
        </a>
    </div>

    <div class="bottom-nav">
        <a href="dashboard.html" class="active"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="reports.html"><i class="fas fa-chart-line"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
        <a href="#" onclick="showNotifications()"><i class="fas fa-bell"></i> ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</a>
        <a href="#" onclick="toggleDarkMode(event)"><i class="fas fa-adjust"></i> Ø§Ù„Ù…Ø¸Ù‡Ø±</a>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-5" data-aos="fade-down">
            <div>
                <h2 style="color:#1E3A8A; font-weight: 900;">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
                <small class="text-muted">Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† Ø§Ù„Ø°ÙƒÙŠ</small>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <button class="notification-btn" onclick="showNotifications()">
                    <i class="fas fa-bell fa-lg"></i>
                    <span id="notifyBadge" class="badge-notify">0</span>
                </button>

                <div class="d-none d-md-flex gap-2">
                    <button class="btn btn-danger text-white fw-bold px-3" onclick="openGeneralReport()">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-success text-white fw-bold px-3" onclick="exportToCSV()">
                        <i class="fas fa-file-csv"></i> Excel
                    </button>
                </div>
            </div>
        </div>

        <div id="summary-cards" class="row"></div>

        <div class="filter-section mt-5" data-aos="zoom-in-up">
            <h5 class="mb-3 text-primary"><i class="fas fa-filter ms-2"></i> ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5>
            <div class="row g-3">
                <div class="col-12 col-md-3">
                    <select id="filterRep" class="form-select" onchange="applyFilters()"><option value="all">Ø§Ù„ÙƒÙ„</option></select>
                </div>
                <div class="col-6 col-md-3"><input type="date" id="filterStartDate" class="form-control" onchange="applyFilters()"></div>
                <div class="col-6 col-md-3"><input type="date" id="filterEndDate" class="form-control" onchange="applyFilters()"></div>
                <div class="col-12 col-md-3"><button class="btn btn-secondary w-100 fw-bold" onclick="resetFilters()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button></div>
            </div>
        </div>

        <div class="table-responsive" data-aos="fade-up">
            <h5 class="mb-4 table-title fw-bold"><i class="fas fa-list-alt ms-2"></i> Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h5>
            <div id="visits-container" class="text-center p-5">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

    <div class="modal fade" id="generalReportModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h5>
                    <div class="mx-3">
                        <select id="reportRepFilter" class="form-select w-auto" onchange="updateReportView(); resetAIAnalysis();">
                            <option value="all">Ø§Ù„ÙƒÙ„</option>
                        </select>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="report-toolbar text-center p-3 bg-dark">
                        <button id="btnGenerateAI" class="btn btn-warning fw-bold px-4" onclick="generateAIAnalysis()"><i class="fas fa-magic ms-2"></i> AI</button>
                        <button id="btnDownloadPDF" class="btn btn-primary fw-bold px-4 ms-2" onclick="downloadFullReport()"><i class="fas fa-download ms-2"></i> ØªØ­Ù…ÙŠÙ„ PDF</button>
                    </div>
                    <div id="printArea">
                        <h2 class="text-center" style="color: #1e3a8a; margin-top:20px;">ØªÙ‚Ø±ÙŠØ± Voco CRM</h2>
                        <div id="aiSection" style="display:none; background:#e0f2fe; padding:15px; margin:20px 0;"></div>
                        <div id="chartContainer" style="height: 300px;"><canvas id="dashboardBarChart"></canvas></div>
                        <table class="table table-bordered mt-4" style="font-size: 11px;">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
                                    <th>Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…</th>
                                    <th>Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ù…</th>
                                    <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="rptBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ğŸ‘‡ğŸ‘‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ù„Ø³Ø­Ø±ÙŠ ğŸ‘‡ğŸ‘‡
        const BASE_URL = '/api'; 
        
        let allVisitsData = []; 
        let currentNotifications = [];
        let barChart = null;

        // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function loadData() {
            try {
                // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª
                const resVisits = await axios.get(`${BASE_URL}/visits`);
                allVisitsData = resVisits.data.data;
                applyFilters(); 
                populateRepFilters();

                // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                const resNotify = await axios.get(`${BASE_URL}/notifications`);
                currentNotifications = resNotify.data.data;
                updateNotificationBadge(resNotify.data.unreadCount);

            } catch (e) { 
                console.error("Error:", e);
                if(document.getElementById('visits-container').innerText.includes('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„')) {
                    document.getElementById('visits-container').innerHTML = `<div class="alert alert-danger">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±</div>`;
                }
            }
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notifyBadge');
            if (count > 0) {
                badge.innerText = count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        function showNotifications() {
            let htmlContent = '<div class="text-end">';
            if (currentNotifications.length === 0) {
                htmlContent += '<p class="text-muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>';
            } else {
                currentNotifications.forEach(n => {
                    let alertClass = n.type === 'warning' ? 'alert-warning' : (n.type === 'success' ? 'alert-success' : 'alert-info');
                    const time = new Date(n.created_at).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
                    htmlContent += `
                        <div class="alert ${alertClass} mb-2 p-2" style="font-size:13px;">
                            <div class="d-flex justify-content-between">
                                <strong>${n.title}</strong>
                                <small>${time}</small>
                            </div>
                            <div>${n.message}</div>
                        </div>
                    `;
                });
            }
            htmlContent += '</div>';
            Swal.fire({
                title: 'ğŸ”” Ø¢Ø®Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª',
                html: htmlContent,
                showConfirmButton: false,
                showCloseButton: true,
                background: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#fff',
                color: document.body.classList.contains('dark-mode') ? '#fff' : '#000'
            });
        }

        function populateRepFilters() {
            const reps = [...new Set(allVisitsData.map(v => v.rep_name).filter(r => r))]; 
            
            const filterRep = document.getElementById('filterRep');
            const currentSelected = filterRep.value;
            filterRep.innerHTML = '<option value="all">Ø§Ù„ÙƒÙ„</option>'; 
            reps.forEach(r => filterRep.innerHTML += `<option value="${r}" ${r===currentSelected?'selected':''}>${r}</option>`);

            const reportRepFilter = document.getElementById('reportRepFilter');
            reportRepFilter.innerHTML = '<option value="all">Ø§Ù„ÙƒÙ„</option>'; 
            reps.forEach(r => reportRepFilter.innerHTML += `<option value="${r}">${r}</option>`);
        }

        function applyFilters() {
            const rep = document.getElementById('filterRep').value;
            const start = document.getElementById('filterStartDate').value;
            const end = document.getElementById('filterEndDate').value;
            
            const filtered = allVisitsData.filter(v => {
                const d = new Date(v.created_at).setHours(0,0,0,0);
                return (rep==='all' || v.rep_name===rep) && (!start || d >= new Date(start).setHours(0,0,0,0)) && (!end || d <= new Date(end).setHours(0,0,0,0));
            });
            renderDashboard(filtered);
        }

        function resetFilters() {
            document.getElementById('filterRep').value = 'all';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            applyFilters();
        }

        function renderDashboard(data) {
            const total = data.length;
            const reps = [...new Set(data.map(v => v.rep_name))].length;
            
            document.getElementById('summary-cards').innerHTML = `
                <div class="col-md-6 mb-4" data-aos="fade-right">
                    <div class="status-card card-visits">
                        <h2>${total}</h2><p>Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</p>
                        <ul class="bubbles"><li></li><li></li><li></li><li></li></ul>
                    </div>
                </div>
                <div class="col-md-6 mb-4" data-aos="fade-left">
                    <div class="status-card card-reps">
                        <h2>${reps}</h2><p>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</p>
                        <ul class="bubbles"><li></li><li></li><li></li><li></li></ul>
                    </div>
                </div>
            `;
            
            // ğŸ› ï¸ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ù…ÙƒØ§Ù†ØŒ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…ØŒ Ø§Ù„Ù…ÙˆØ¹Ø¯)
            let html = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                        <th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
                        <th>Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…</th>
                        <th>Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ù…</th>
                        <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                    </tr>
                </thead>
                <tbody>`;
            
            if (data.length === 0) {
                html += `<tr><td colspan="9" class="text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
            } else {
                data.slice(0, 50).forEach(v => { 
                    const mapLink = v.lat && v.lng 
                        ? `<a href="http://googleusercontent.com/maps.google.com/?q=${v.lat},${v.lng}" target="_blank" class="text-primary"><i class="fas fa-map-marker-alt"></i></a>`
                        : '<span class="text-muted">-</span>';

                    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    const placeBadge = v.place_type ? `<span class="badge-place">${v.place_type}</span>` : '-';
                    const interestBadge = v.is_interested ? `<span class="badge-interested">Ù…Ù‡ØªÙ…</span>` : `<span class="badge-not-interested">ØºÙŠØ± Ù…Ù‡ØªÙ…</span>`;
                    
                    let nextMeeting = '-';
                    if (v.has_next_meeting && v.next_meeting_date) {
                        const nd = new Date(v.next_meeting_date);
                        nextMeeting = `<span style="font-size:10px; font-weight:bold; color:#1e3a8a">${nd.toLocaleDateString()}</span>`;
                    }

                    html += `<tr data-aos="zoom-in">
                        <td>${new Date(v.created_at).toLocaleDateString('ar-EG')}</td>
                        <td>${v.rep_name}</td>
                        <td class="fw-bold">${v.customer_name}</td>
                        <td style="direction:ltr; text-align:right">${v.customer_phone || '-'}</td>
                        <td>${placeBadge}</td>
                        <td>${interestBadge}</td>
                        <td>${nextMeeting}</td>
                        <td class="text-muted text-wrap" style="max-width:200px;">${v.voice_text || ''}</td>
                        <td>${mapLink}</td> 
                    </tr>`;
                });
            }
            html += `</tbody></table>`;
            document.getElementById('visits-container').innerHTML = html;
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ù„Ù€ AI ---
        function openGeneralReport() {
            populateRepFilters();
            updateReportView();
            document.getElementById('aiSection').style.display = 'none'; 
            new bootstrap.Modal(document.getElementById('generalReportModal')).show();
        }
        
        function resetAIAnalysis() {
            document.getElementById('aiSection').style.display = 'none';
            document.getElementById('aiSection').innerHTML = '';
        }

        function getFilteredDataForReport() {
            const rep = document.getElementById('reportRepFilter').value;
            return allVisitsData.filter(v => rep === 'all' || v.rep_name === rep);
        }

        function updateReportView() {
            const filteredData = getFilteredDataForReport();
            const tbody = document.getElementById('rptBody'); 
            tbody.innerHTML = '';
            
            // ğŸ› ï¸ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù€ PDF
            filteredData.slice(0, 15).forEach(v => {
                const interest = v.is_interested ? 'Ù†Ø¹Ù…' : 'Ù„Ø§';
                const nextM = v.has_next_meeting ? 'ÙŠÙˆØ¬Ø¯' : '-';
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(v.created_at).toLocaleDateString()}</td>
                        <td>${v.rep_name}</td>
                        <td>${v.customer_name}</td>
                        <td>${v.place_type || '-'}</td>
                        <td>${interest}</td>
                        <td>${nextM}</td>
                        <td>${v.voice_text || ''}</td>
                    </tr>
                `;
            });
            
            const dateCounts = {}; 
            filteredData.forEach(v => {
                const d = new Date(v.created_at).toLocaleDateString('en-GB');
                dateCounts[d] = (dateCounts[d] || 0) + 1;
            });
            
            if(barChart) barChart.destroy();
            barChart = new Chart(document.getElementById('dashboardBarChart'), { 
                type: 'bar', 
                data: { 
                    labels: Object.keys(dateCounts), 
                    datasets: [{ label: 'Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª', data: Object.values(dateCounts), backgroundColor: '#FF5722' }] 
                } 
            });
        }
        
        async function generateAIAnalysis() {
            const filteredData = getFilteredDataForReport();
            const selectedRep = document.getElementById('reportRepFilter').value;
            const aiSection = document.getElementById('aiSection');
            
            aiSection.style.display = 'block';
            aiSection.innerHTML = '<p class="text-center"><i class="fas fa-sync fa-spin ms-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</p>';
            await new Promise(r => setTimeout(r, 1500)); 

            const totalVisits = filteredData.length;
            const interestedCount = filteredData.filter(v => v.is_interested).length;
            const interestRate = totalVisits > 0 ? Math.round((interestedCount / totalVisits) * 100) : 0;

            let analysisText = `
                <h5 class="fw-bold text-primary mb-3">ğŸ¤– ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h5>
                <ul class="mb-3">
                    <li>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: <strong>${totalVisits}</strong></li>
                    <li>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ù‡ØªÙ…ÙŠÙ†: <strong>${interestedCount}</strong> (Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­: ${interestRate}%)</li>
                </ul>
            `;

            if (interestRate < 20) {
                analysisText += `<div class="alert alert-danger"><strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù… Ù…Ù†Ø®ÙØ¶Ø© Ø¬Ø¯Ø§Ù‹ (${interestRate}%). ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø¹Ø±Ø¶.</div>`;
            } else if (interestRate > 50) {
                analysisText += `<div class="alert alert-success"><strong>Ù…Ù…ØªØ§Ø²:</strong> Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ ÙˆÙ†Ø³Ø¨Ø© Ù‚Ø¨ÙˆÙ„ Ø¹Ø§Ù„ÙŠØ©.</div>`;
            } else {
                analysisText += `<div class="alert alert-warning"><strong>Ù…ØªÙˆØ³Ø·:</strong> Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ù‚Ø¨ÙˆÙ„ ÙˆÙ„ÙƒÙ† ÙŠØ­ØªØ§Ø¬ Ù„ØªØ­Ø³ÙŠÙ†.</div>`;
            }
            
            aiSection.innerHTML = analysisText;
        }

        async function downloadFullReport() {
            document.getElementById('btnDownloadPDF').disabled = true;
            document.getElementById('btnDownloadPDF').innerHTML = '<i class="fas fa-spinner fa-spin ms-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';

            const printArea = document.getElementById('printArea');
            const canvas = await html2canvas(printArea, { scale: 2, useCORS: true, allowTaint: true, scrollY: -window.scrollY });
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4'); 
            const imgData = canvas.toDataURL('image/png');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgHeight = canvas.height * pdfWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;
            
            pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
            heightLeft -= pdfHeight;
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;
            }
            pdf.save(`Voco_CRM_Report_${new Date().toISOString().slice(0, 10)}.pdf`);
            document.getElementById('btnDownloadPDF').disabled = false;
            document.getElementById('btnDownloadPDF').innerHTML = '<i class="fas fa-download ms-2"></i> ØªØ­Ù…ÙŠÙ„ PDF';
        }

        function toggleDarkMode(e) {
            e.preventDefault(); document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
            updateToggleIcon(document.body.classList.contains('dark-mode'));
        }
        function updateToggleIcon(isDark) {
            const btn = document.getElementById('darkModeToggle');
            if(btn) btn.innerHTML = isDark ? '<i class="fas fa-sun"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­' : '<i class="fas fa-moon"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù…';
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('darkMode') === 'enabled') document.body.classList.add('dark-mode');
            updateToggleIcon(localStorage.getItem('darkMode') === 'enabled');
            loadData();
        });

        setInterval(loadData, 30000); 
    </script>
    
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>AOS.init({ duration: 1000, once: true });</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>