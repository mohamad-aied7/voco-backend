<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voco CRM - Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            direction: rtl;
            text-align: right;
        }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar {
            width: 250px;
            height: 100vh;
            background-color: #1e3a8a; /* Ø£Ø²Ø±Ù‚ Ø±Ø³Ù…ÙŠ */
            padding: 20px;
            position: fixed;
            top: 0;
            right: 0;
            z-index: 1000;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        }
        .sidebar a {
            display: flex; align-items: center; padding: 12px 15px; margin-bottom: 10px;
            color: #d1d5db; text-decoration: none; border-radius: 10px; transition: 0.3s;
        }
        .sidebar a:hover, .sidebar a.active {
            background-color: #3b82f6; color: white;
        }
        .sidebar .logo-text {
            color: white; font-weight: 900; font-size: 22px; margin-right: 10px;
        }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .main-content {
            margin-right: 250px;
            padding: 30px;
        }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© */
        .status-card {
            background: white; border-radius: 15px; padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: none;
            transition: transform 0.3s;
        }
        .status-card:hover { transform: translateY(-5px); }
        .card-icon {
            width: 50px; height: 50px; border-radius: 12px; display: flex;
            align-items: center; justify-content: center; font-size: 24px; margin-bottom: 15px;
        }
        .bg-visits { background-color: #e0f2fe; color: #0284c7; }
        .bg-users { background-color: #dcfce7; color: #166534; }
        .bg-rate { background-color: #fef9c3; color: #854d0e; }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-card {
            background: white; border-radius: 15px; padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-top: 30px;
        }
        .table thead th {
            background-color: #f8fafc; color: #64748b; border-bottom: 2px solid #e2e8f0;
            padding: 15px; font-size: 13px;
        }
        .table tbody td {
            padding: 15px; vertical-align: middle; font-size: 13px; color: #334155;
        }

        /* Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© */
        .badge-interested { background-color: #dcfce7; color: #166534; padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .badge-not { background-color: #fee2e2; color: #991b1b; padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }

        /* Ù‚Ø³Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ */
        #aiResult {
            display: none;
            background-color: #fff; border-right: 4px solid #f59e0b;
            padding: 20px; border-radius: 8px; margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-right: 0; padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="d-flex align-items-center mb-5 border-bottom pb-3" style="border-color: #3b82f6 !important;">
            <i class="fas fa-satellite-dish fa-2x" style="color: #FF5722; margin-left: 10px;"></i>
            <h5 class="mb-0 logo-text">VOCO CRM</h5>
        </div>
        <a href="dashboard.html" class="active"><i class="fas fa-tachometer-alt ms-2"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</a>
        <a href="#" onclick="alert('Ù‚Ø±ÙŠØ¨Ø§Ù‹')"><i class="fas fa-chart-line ms-2"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
        <a href="#" onclick="alert('Ù‚Ø±ÙŠØ¨Ø§Ù‹')"><i class="fas fa-users ms-2"></i> Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</a>
    </div>

    <div class="main-content">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                <span class="text-muted">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</span>
            </div>
            <div>
                <button class="btn btn-warning text-dark fw-bold shadow-sm" onclick="runAIAnalysis()">
                    <i class="fas fa-robot ms-2"></i> ØªØ­Ù„ÙŠÙ„ AI
                </button>
                <button class="btn btn-danger fw-bold shadow-sm ms-2" onclick="generatePDF()">
                    <i class="fas fa-file-pdf ms-2"></i> ØªÙ‚Ø±ÙŠØ± PDF
                </button>
            </div>
        </div>

        <div id="aiResult">
            <h5 class="text-warning fw-bold mb-3"><i class="fas fa-lightbulb ms-2"></i> Ø±Ø¤Ù‰ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h5>
            <div id="aiText" style="line-height: 1.8; color: #4b5563;"></div>
        </div>

        <div class="row g-4">
            <div class="col-md-4">
                <div class="status-card">
                    <div class="card-icon bg-visits"><i class="fas fa-walking"></i></div>
                    <h3 class="fw-bold" id="totalVisits">0</h3>
                    <span class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="status-card">
                    <div class="card-icon bg-users"><i class="fas fa-check-circle"></i></div>
                    <h3 class="fw-bold" id="interestedCount">0</h3>
                    <span class="text-muted">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ù‡ØªÙ…ÙŠÙ†</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="status-card">
                    <div class="card-icon bg-rate"><i class="fas fa-percentage"></i></div>
                    <h3 class="fw-bold" id="conversionRate">0%</h3>
                    <span class="text-muted">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</span>
                </div>
            </div>
        </div>

        <div class="table-card">
            <h5 class="fw-bold mb-4">Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="6" class="text-center py-4 text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        const BASE_URL = '/api';
        let allVisits = [];

        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function loadData() {
            try {
                const res = await axios.get(`${BASE_URL}/visits`);
                allVisits = res.data.data;
                renderStats(allVisits);
                renderTable(allVisits);
            } catch (e) {
                console.error(e);
            }
        }

        // 2. Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function renderStats(data) {
            const total = data.length;
            const interested = data.filter(v => v.is_interested).length;
            const rate = total > 0 ? Math.round((interested / total) * 100) : 0;

            document.getElementById('totalVisits').innerText = total;
            document.getElementById('interestedCount').innerText = interested;
            document.getElementById('conversionRate').innerText = `${rate}%`;
        }

        // 3. Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
                return;
            }
            let html = '';
            data.slice(0, 20).forEach(v => {
                const statusBadge = v.is_interested 
                    ? '<span class="badge-interested">Ù…Ù‡ØªÙ…</span>' 
                    : '<span class="badge-not">ØºÙŠØ± Ù…Ù‡ØªÙ…</span>';
                
                html += `
                    <tr>
                        <td>${new Date(v.created_at).toLocaleDateString('en-GB')}</td>
                        <td class="fw-bold">${v.rep_name}</td>
                        <td>${v.customer_name}</td>
                        <td>${v.place_type || '-'}</td>
                        <td>${statusBadge}</td>
                        <td class="text-muted text-truncate" style="max-width: 200px;">${v.voice_text || ''}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // ---------------------------------------------------------
        // ğŸ§  Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: ØªØ­Ù„ÙŠÙ„ AI
        // ---------------------------------------------------------
        function runAIAnalysis() {
            const aiDiv = document.getElementById('aiResult');
            const aiText = document.getElementById('aiText');
            aiDiv.style.display = 'block';
            aiText.innerHTML = '<span class="text-primary fw-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... <i class="fas fa-spinner fa-spin"></i></span>';

            // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ (Logic)
            setTimeout(() => {
                const total = allVisits.length;
                const interested = allVisits.filter(v => v.is_interested).length;
                
                // Ø£ÙƒØ«Ø± Ù…Ù†Ø¯ÙˆØ¨ Ù†Ø´Ø§Ø·Ø§Ù‹
                const reps = {};
                allVisits.forEach(v => { reps[v.rep_name] = (reps[v.rep_name] || 0) + 1; });
                const topRep = Object.keys(reps).reduce((a, b) => reps[a] > reps[b] ? a : b, 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');

                let feedback = "";
                if ((interested/total) > 0.5) feedback = "Ù…Ù…ØªØ§Ø²! Ø§Ù„ÙØ±ÙŠÙ‚ ÙŠØ­Ù‚Ù‚ Ù†ØªØ§Ø¦Ø¬ Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©.";
                else feedback = "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ ØªØ­Ø³ÙŠÙ† Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡.";

                aiText.innerHTML = `
                    <ul class="mb-0">
                        <li>ØªÙ… ØªØ­Ù„ÙŠÙ„ <strong>${total}</strong> Ø²ÙŠØ§Ø±Ø© Ù…ÙŠØ¯Ø§Ù†ÙŠØ©.</li>
                        <li>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø£Ù†Ø´Ø· Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù‡Ùˆ <strong>${topRep}</strong>.</li>
                        <li>Ù†Ø³Ø¨Ø© Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‡ÙŠ <strong>${Math.round((interested/total)*100)}%</strong>.</li>
                        <li><strong>Ø§Ù„ØªÙˆØµÙŠØ©:</strong> ${feedback}</li>
                    </ul>
                `;
            }, 1000);
        }

        // ---------------------------------------------------------
        // ğŸ“„ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: ØªÙ‚Ø±ÙŠØ± PDF (ØªØµÙ…ÙŠÙ… Ø±Ø³Ù…ÙŠ)
        // ---------------------------------------------------------
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            doc.setFontSize(22);
            doc.setTextColor(30, 58, 138); // Ø£Ø²Ø±Ù‚ ØºØ§Ù…Ù‚
            doc.text("Voco CRM Report", 105, 20, { align: "center" });
            
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 28, { align: "center" });

            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const tableColumn = ["Date", "Agent", "Customer", "Place", "Status", "Note"];
            const tableRows = [];

            allVisits.forEach(v => {
                const visitData = [
                    new Date(v.created_at).toLocaleDateString(),
                    v.rep_name,
                    v.customer_name,
                    v.place_type || "-",
                    v.is_interested ? "Interested" : "Not Interested",
                    v.voice_text || "-"
                ];
                tableRows.push(visitData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40,
                theme: 'grid', // Ù…Ø®Ø·Ø· Ø±Ø³Ù…ÙŠ
                headStyles: { fillColor: [30, 58, 138], textColor: 255 }, // Ø±Ø£Ø³ Ø£Ø²Ø±Ù‚
                styles: { fontSize: 9, cellPadding: 4 },
                alternateRowStyles: { fillColor: [240, 242, 245] } // ØµÙÙˆÙ Ù…Ø®Ø·Ø·Ø©
            });

            doc.save("Voco_Report.pdf");
        }

        // ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        loadData();
        setInterval(loadData, 30000); 
    </script>
</body>
</html>