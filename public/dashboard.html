<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voco CRM - Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <style>
        :root {
            --bg-color: #020005;
            --card-bg: #060010;
            --text-color: #ffffff;
            --glow-color: 132, 0, 255; /* Purple Glow */
            --spotlight-radius: 300px;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* القائمة الجانبية */
        .sidebar {
            width: 250px;
            height: 100vh;
            background-color: rgba(6, 0, 16, 0.9);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            position: fixed;
            top: 0;
            right: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .sidebar a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            color: #8b8b8b;
            text-decoration: none;
            border-radius: 12px;
            transition: 0.3s;
            border: 1px solid transparent;
        }
        
        .sidebar a:hover, .sidebar a.active {
            background: rgba(132, 0, 255, 0.1);
            color: #fff;
            border-color: rgba(132, 0, 255, 0.3);
            box-shadow: 0 0 15px rgba(132, 0, 255, 0.2);
        }

        /* المحتوى الرئيسي */
        .main-content {
            margin-right: 250px;
            padding: 30px;
        }

        /* شبكة البينتو (Magic Bento Grid) */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
            padding-bottom: 50px;
        }

        /* الكارت السحري */
        .magic-card {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: transform 0.1s;
        }

        /* تأثير الإضاءة (Spotlight) */
        .magic-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(
                circle at var(--mouse-x) var(--mouse-y),
                rgba(var(--glow-color), 0.15),
                transparent var(--spotlight-radius)
            );
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1;
        }

        .magic-card:hover::before {
            opacity: 1;
        }

        /* محتوى الكارت */
        .card-content {
            position: relative;
            z-index: 2;
        }

        .card-label {
            display: inline-block;
            padding: 5px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 11px;
            color: #a1a1aa;
            margin-bottom: 20px;
        }

        .card-value {
            font-size: 36px;
            font-weight: 900;
            margin-bottom: 5px;
            background: linear-gradient(to right, #fff, #a1a1aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card-desc {
            color: #71717a;
            font-size: 14px;
        }

        /* الجدول الشفاف */
        .table-container {
            background: rgba(6, 0, 16, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin-top: 30px;
        }

        .custom-table {
            width: 100%;
            border-collapse: collapse;
            color: #e4e4e7;
        }

        .custom-table th {
            text-align: right;
            padding: 15px;
            color: #a1a1aa;
            font-size: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .custom-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 14px;
        }

        .custom-table tr:last-child td { border-bottom: none; }
        .custom-table tr:hover td { background: rgba(255, 255, 255, 0.02); }

        /* شارات الحالة */
        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
        }
        .bg-success-subtle { background: rgba(34, 197, 94, 0.1); color: #4ade80; }
        .bg-danger-subtle { background: rgba(239, 68, 68, 0.1); color: #f87171; }
        
        /* التجاوب */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-right: 0; padding: 15px; }
            .bento-grid { grid-template-columns: 1fr; }
        }
        
        /* النقاط المتناثرة (Particles) */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(132, 0, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            z-index: 10;
        }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="d-flex align-items-center mb-5 pb-3 border-bottom border-secondary">
            <i class="fas fa-satellite-dish fa-2x" style="color: #8400ff; margin-left: 10px;"></i>
            <h5 class="mb-0 fw-bold">VOCO CRM</h5>
        </div>
        <a href="dashboard.html" class="active"><i class="fas fa-th-large"></i> الرئيسية</a>
        <a href="reports.html"><i class="fas fa-chart-pie"></i> التقارير</a>
        <a href="users.html"><i class="fas fa-users"></i> المندوبين</a>
        <a href="settings.html"><i class="fas fa-sliders-h"></i> الإعدادات</a>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold">لوحة القيادة ✨</h2>
                <span class="text-secondary" style="font-size: 12px;">مرحباً بك في نظام الذكاء الاصطناعي</span>
            </div>
            <button class="btn btn-outline-light rounded-pill px-4" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> تحديث
            </button>
        </div>

        <div class="bento-grid" id="bentoGrid">
            
            <div class="magic-card">
                <div class="card-content">
                    <div class="card-label">Visits</div>
                    <div class="card-value" id="totalVisits">0</div>
                    <div class="card-desc">إجمالي الزيارات المسجلة</div>
                </div>
            </div>

            <div class="magic-card">
                <div class="card-content">
                    <div class="card-label">Agents</div>
                    <div class="card-value" id="activeAgents">0</div>
                    <div class="card-desc">عدد المندوبين النشطين</div>
                </div>
            </div>

            <div class="magic-card">
                <div class="card-content">
                    <div class="card-label">Conversion</div>
                    <div class="card-value" id="interestRate">0%</div>
                    <div class="card-desc">نسبة العملاء المهتمين</div>
                </div>
            </div>

        </div>

        <div class="table-container">
            <div class="d-flex justify-content-between mb-4">
                <h5 class="fw-bold">سجل الزيارات الحية</h5>
                <span class="badge bg-success-subtle">Live Updates</span>
            </div>
            <table class="custom-table">
                <thead>
                    <tr>
                        <th>التاريخ</th>
                        <th>المندوب</th>
                        <th>العميل</th>
                        <th>الهاتف</th>
                        <th>المكان</th>
                        <th>الحالة</th>
                        <th>الموقع</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="7" class="text-center py-4 text-secondary">جاري تحميل البيانات...</td></tr>
                </tbody>
            </table>
        </div>

    </div>

    <script>
        const BASE_URL = '/api';

        // 1. منطق الـ Magic Cards (اللمعان والميلان)
        const cards = document.querySelectorAll('.magic-card');
        
        cards.forEach(card => {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // تحديث مكان الضوء
                card.style.setProperty('--mouse-x', `${x}px`);
                card.style.setProperty('--mouse-y', `${y}px`);

                // حساب الميلان (Tilt)
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const rotateX = ((y - centerY) / centerY) * -5; // عكس الاتجاه
                const rotateY = ((x - centerX) / centerX) * 5;

                gsap.to(card, {
                    transform: `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`,
                    duration: 0.1
                });
            });

            card.addEventListener('mouseleave', () => {
                gsap.to(card, {
                    transform: 'perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)',
                    duration: 0.5,
                    ease: 'power2.out'
                });
            });
            
            // تأثير النقاط (Particles) عند النقر
            card.addEventListener('click', (e) => {
                createParticles(e.clientX, e.clientY);
            });
        });

        function createParticles(x, y) {
            for(let i=0; i<8; i++) {
                const p = document.createElement('div');
                p.classList.add('particle');
                document.body.appendChild(p);
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = 50 + Math.random() * 50;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;

                gsap.fromTo(p, 
                    { x: x, y: y, opacity: 1, scale: 1 },
                    { 
                        x: x + tx, 
                        y: y + ty, 
                        opacity: 0, 
                        scale: 0, 
                        duration: 0.8, 
                        ease: "power2.out",
                        onComplete: () => p.remove()
                    }
                );
            }
        }

        // 2. جلب البيانات الحقيقية
        async function loadData() {
            try {
                const res = await axios.get(`${BASE_URL}/visits`);
                const data = res.data.data;
                renderStats(data);
                renderTable(data);
            } catch (e) {
                console.error(e);
            }
        }

        function renderStats(data) {
            const total = data.length;
            const agents = new Set(data.map(v => v.rep_name)).size;
            const interested = data.filter(v => v.is_interested).length;
            const rate = total > 0 ? Math.round((interested / total) * 100) : 0;

            // عداد متحرك للأرقام
            animateValue("totalVisits", 0, total, 1000);
            animateValue("activeAgents", 0, agents, 1000);
            document.getElementById('interestRate').innerText = `${rate}%`;
        }

        function animateValue(id, start, end, duration) {
            let obj = document.getElementById(id);
            let range = end - start;
            let current = start;
            let increment = end > start ? 1 : -1;
            let stepTime = Math.abs(Math.floor(duration / range));
            if (stepTime < 10) stepTime = 10; 
            
            let timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) clearInterval(timer);
            }, stepTime);
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-secondary">لا توجد بيانات</td></tr>';
                return;
            }
            
            let html = '';
            data.slice(0, 15).forEach(v => {
                const status = v.is_interested 
                    ? '<span class="status-badge bg-success-subtle">مهتم</span>' 
                    : '<span class="status-badge bg-danger-subtle">غير مهتم</span>';
                
                const mapLink = v.lat 
                    ? `<a href="https://www.google.com/maps/search/?api=1&query=${v.lat},${v.lng}" target="_blank" style="color:#8400ff"><i class="fas fa-location-arrow"></i></a>`
                    : '-';

                html += `
                    <tr>
                        <td>${new Date(v.created_at).toLocaleDateString('en-GB')}</td>
                        <td class="fw-bold text-white">${v.rep_name}</td>
                        <td>${v.customer_name}</td>
                        <td style="font-family:monospace; color:#a1a1aa">${v.customer_phone || '-'}</td>
                        <td>${v.place_type || '-'}</td>
                        <td>${status}</td>
                        <td>${mapLink}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        loadData();
        setInterval(loadData, 30000); // تحديث كل 30 ثانية
    </script>
</body>
</html>